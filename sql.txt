-- ============================================
-- COMPLETE DATABASE SCHEMA FOR TRIP MANAGEMENT
-- ============================================

-- Drop existing tables in correct order (respecting foreign keys)
DROP TABLE IF EXISTS public.post_trip_analysis CASCADE;
DROP TABLE IF EXISTS public.trip_overheads CASCADE;
DROP TABLE IF EXISTS public.trip_activities CASCADE;
DROP TABLE IF EXISTS public.trip_meals CASCADE;
DROP TABLE IF EXISTS public.trip_accommodations CASCADE;
DROP TABLE IF EXISTS public.trip_trains CASCADE;
DROP TABLE IF EXISTS public.trip_buses CASCADE;
DROP TABLE IF EXISTS public.trip_flights CASCADE;
DROP TABLE IF EXISTS public.trip_participants CASCADE;
DROP TABLE IF EXISTS public.trips CASCADE;
DROP TABLE IF EXISTS public.institutions CASCADE;
DROP TABLE IF EXISTS public.currencies CASCADE;
DROP TABLE IF EXISTS public.cities CASCADE;
DROP TABLE IF EXISTS public.countries CASCADE;
DROP TABLE IF EXISTS public.users CASCADE;

-- Drop existing types
DROP TYPE IF EXISTS institution_type CASCADE;
DROP TYPE IF EXISTS trip_status CASCADE;
DROP TYPE IF EXISTS user_role CASCADE;

-- ============================================
-- ENUMS
-- ============================================

CREATE TYPE user_role AS ENUM ('admin', 'manager');

CREATE TYPE trip_status AS ENUM (
  'draft',
  'sent',
  'approved',
  'completed',
  'locked'
);

CREATE TYPE institution_type AS ENUM ('school', 'college');

-- ============================================
-- USERS TABLE
-- ============================================

CREATE TABLE public.users (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text NOT NULL UNIQUE,
  name text NOT NULL,
  role user_role NOT NULL,
  created_at timestamptz DEFAULT now()
);

-- Enable RLS
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- RLS Policies for users
CREATE POLICY "Users can view their own data"
  ON public.users FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update their own data"
  ON public.users FOR UPDATE
  USING (auth.uid() = id);

-- ============================================
-- MASTER DATA TABLES
-- ============================================

-- Countries
CREATE TABLE public.countries (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  code text NOT NULL UNIQUE,
  default_currency text NOT NULL,
  created_at timestamptz DEFAULT now()
);

-- Cities
CREATE TABLE public.cities (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  country_id uuid REFERENCES public.countries(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now(),
  UNIQUE(name, country_id)
);

CREATE INDEX idx_cities_country ON public.cities(country_id);

-- Currencies
CREATE TABLE public.currencies (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  name text NOT NULL,
  symbol text NOT NULL,
  rate_to_inr numeric NOT NULL,
  effective_date date NOT NULL,
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_currencies_effective_date ON public.currencies(effective_date DESC);

-- Institutions
CREATE TABLE public.institutions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  type institution_type NOT NULL,
  city text NOT NULL,
  created_at timestamptz DEFAULT now()
);

-- ============================================
-- TRIPS TABLE (Main)
-- ============================================

CREATE TABLE public.trips (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  institution text NOT NULL,
  country text NOT NULL,
  city text NOT NULL,
  start_date date NOT NULL,
  end_date date NOT NULL,
  total_days int NOT NULL CHECK (total_days > 0),
  total_nights int NOT NULL CHECK (total_nights >= 0),
  currency text NOT NULL,
  status trip_status NOT NULL DEFAULT 'draft',

  total_cost numeric NOT NULL DEFAULT 0,
  total_cost_inr numeric NOT NULL DEFAULT 0,
  cost_per_student numeric NOT NULL DEFAULT 0,

  created_by uuid REFERENCES public.users(id) ON DELETE SET NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX idx_trips_created_by ON public.trips(created_by);
CREATE INDEX idx_trips_status ON public.trips(status);
CREATE INDEX idx_trips_created_at ON public.trips(created_at DESC);

-- Enable RLS
ALTER TABLE public.trips ENABLE ROW LEVEL SECURITY;

-- RLS Policies for trips
CREATE POLICY "Users can view their own trips"
  ON public.trips FOR SELECT
  USING (created_by = auth.uid());

CREATE POLICY "Users can create trips"
  ON public.trips FOR INSERT
  WITH CHECK (created_by = auth.uid());

CREATE POLICY "Users can update their own trips"
  ON public.trips FOR UPDATE
  USING (created_by = auth.uid());

CREATE POLICY "Users can delete their own trips"
  ON public.trips FOR DELETE
  USING (created_by = auth.uid());

-- Auto-update updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_trips_updated_at
  BEFORE UPDATE ON public.trips
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- TRIP PARTICIPANTS
-- ============================================

CREATE TABLE public.trip_participants (
  trip_id uuid PRIMARY KEY REFERENCES public.trips(id) ON DELETE CASCADE,

  boys int NOT NULL DEFAULT 0 CHECK (boys >= 0),
  girls int NOT NULL DEFAULT 0 CHECK (girls >= 0),
  male_faculty int NOT NULL DEFAULT 0 CHECK (male_faculty >= 0),
  female_faculty int NOT NULL DEFAULT 0 CHECK (female_faculty >= 0),
  male_vxplorers int NOT NULL DEFAULT 0 CHECK (male_vxplorers >= 0),
  female_vxplorers int NOT NULL DEFAULT 0 CHECK (female_vxplorers >= 0),

  total_students int NOT NULL DEFAULT 0,
  total_faculty int NOT NULL DEFAULT 0,
  total_vxplorers int NOT NULL DEFAULT 0,
  total_participants int NOT NULL DEFAULT 0
);

-- Enable RLS
ALTER TABLE public.trip_participants ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip participants access"
  ON public.trip_participants FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- ============================================
-- TRANSPORT TABLES
-- ============================================

-- Flights
CREATE TABLE public.trip_flights (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid REFERENCES public.trips(id) ON DELETE CASCADE,

  from_city text NOT NULL,
  to_city text NOT NULL,
  airline text NOT NULL,
  flight_number text,
  departure_time timestamptz,
  arrival_time timestamptz,

  cost_per_person numeric NOT NULL DEFAULT 0 CHECK (cost_per_person >= 0),
  currency text NOT NULL,
  description text,

  total_cost numeric NOT NULL DEFAULT 0,
  total_cost_inr numeric NOT NULL DEFAULT 0
);

CREATE INDEX idx_trip_flights_trip ON public.trip_flights(trip_id);

ALTER TABLE public.trip_flights ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip flights access"
  ON public.trip_flights FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- Buses
CREATE TABLE public.trip_buses (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid REFERENCES public.trips(id) ON DELETE CASCADE,

  name text NOT NULL,
  seating_capacity int NOT NULL DEFAULT 0 CHECK (seating_capacity > 0),
  cost_per_bus numeric NOT NULL DEFAULT 0 CHECK (cost_per_bus >= 0),
  currency text NOT NULL,
  number_of_days int NOT NULL DEFAULT 1 CHECK (number_of_days > 0),
  quantity int NOT NULL DEFAULT 1 CHECK (quantity > 0),
  description text,

  total_cost numeric NOT NULL DEFAULT 0,
  total_cost_inr numeric NOT NULL DEFAULT 0
);

CREATE INDEX idx_trip_buses_trip ON public.trip_buses(trip_id);

ALTER TABLE public.trip_buses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip buses access"
  ON public.trip_buses FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- Trains
CREATE TABLE public.trip_trains (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid REFERENCES public.trips(id) ON DELETE CASCADE,

  name text NOT NULL,
  train_number text,
  class text,
  timing text,

  cost_per_person numeric NOT NULL DEFAULT 0 CHECK (cost_per_person >= 0),
  currency text NOT NULL,
  description text,

  total_cost numeric NOT NULL DEFAULT 0,
  total_cost_inr numeric NOT NULL DEFAULT 0
);

CREATE INDEX idx_trip_trains_trip ON public.trip_trains(trip_id);

ALTER TABLE public.trip_trains ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip trains access"
  ON public.trip_trains FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- ============================================
-- ACCOMMODATIONS (WITH AUTO-ALLOCATION SUPPORT)
-- ============================================

CREATE TABLE public.trip_accommodations (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid REFERENCES public.trips(id) ON DELETE CASCADE,

  hotel_name text NOT NULL,
  city text NOT NULL,
  number_of_nights int NOT NULL DEFAULT 1 CHECK (number_of_nights > 0),
  currency text NOT NULL,
  breakfast_included boolean NOT NULL DEFAULT false,

  -- NEW: Room type configurations for auto-allocation
  room_types jsonb NOT NULL DEFAULT '[]'::jsonb,
  -- Structure: [{ roomType: string, capacityPerRoom: number, costPerRoom: number }]

  -- Auto-calculated room allocation
  room_allocation jsonb NOT NULL DEFAULT '{
    "boysRooms": 0,
    "girlsRooms": 0,
    "maleFacultyRooms": 0,
    "femaleFacultyRooms": 0,
    "maleVXplorerRooms": 0,
    "femaleVXplorerRooms": 0,
    "totalRooms": 0
  }'::jsonb,
  -- Structure includes breakdown: { ..., breakdown: { boys: [...], girls: [...], etc. } }

  total_rooms int NOT NULL DEFAULT 0,
  total_cost numeric NOT NULL DEFAULT 0,
  total_cost_inr numeric NOT NULL DEFAULT 0,

  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_trip_accommodations_trip ON public.trip_accommodations(trip_id);
CREATE INDEX idx_trip_accommodations_room_types ON public.trip_accommodations USING gin (room_types);
CREATE INDEX idx_trip_accommodations_room_allocation ON public.trip_accommodations USING gin (room_allocation);

ALTER TABLE public.trip_accommodations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip accommodations access"
  ON public.trip_accommodations FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- Comments for documentation
COMMENT ON COLUMN public.trip_accommodations.room_types IS 
'JSONB array of room type configurations: [{ roomType: string, capacityPerRoom: number, costPerRoom: number }]. Used for auto-allocation.';

COMMENT ON COLUMN public.trip_accommodations.room_allocation IS 
'JSONB object storing room allocation with breakdown: { boysRooms, girlsRooms, ..., breakdown: { boys: [...], girls: [...] } }';

-- ============================================
-- MEALS
-- ============================================

CREATE TABLE public.trip_meals (
  trip_id uuid PRIMARY KEY REFERENCES public.trips(id) ON DELETE CASCADE,
  
  breakfast_cost_per_person numeric NOT NULL DEFAULT 0 CHECK (breakfast_cost_per_person >= 0),
  lunch_cost_per_person numeric NOT NULL DEFAULT 0 CHECK (lunch_cost_per_person >= 0),
  dinner_cost_per_person numeric NOT NULL DEFAULT 0 CHECK (dinner_cost_per_person >= 0),
  
  currency text NOT NULL,
  total_days int NOT NULL DEFAULT 1 CHECK (total_days > 0),
  total_participants int NOT NULL DEFAULT 0,
  
  daily_cost_per_person numeric NOT NULL DEFAULT 0,
  total_cost numeric NOT NULL DEFAULT 0,
  total_cost_inr numeric NOT NULL DEFAULT 0
);

ALTER TABLE public.trip_meals ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip meals access"
  ON public.trip_meals FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- ============================================
-- ACTIVITIES
-- ============================================

CREATE TABLE public.trip_activities (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid REFERENCES public.trips(id) ON DELETE CASCADE,

  name text NOT NULL,
  entry_cost numeric NOT NULL DEFAULT 0 CHECK (entry_cost >= 0),
  transport_cost numeric NOT NULL DEFAULT 0 CHECK (transport_cost >= 0),
  guide_cost numeric NOT NULL DEFAULT 0 CHECK (guide_cost >= 0),
  currency text NOT NULL,
  description text,

  total_cost numeric NOT NULL DEFAULT 0,
  total_cost_inr numeric NOT NULL DEFAULT 0
);

CREATE INDEX idx_trip_activities_trip ON public.trip_activities(trip_id);

ALTER TABLE public.trip_activities ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip activities access"
  ON public.trip_activities FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- ============================================
-- OVERHEADS
-- ============================================

CREATE TABLE public.trip_overheads (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid REFERENCES public.trips(id) ON DELETE CASCADE,

  name text NOT NULL,
  amount numeric NOT NULL DEFAULT 0 CHECK (amount >= 0),
  currency text NOT NULL,
  hide_from_client boolean NOT NULL DEFAULT false,
  total_cost_inr numeric NOT NULL DEFAULT 0
);

CREATE INDEX idx_trip_overheads_trip ON public.trip_overheads(trip_id);

ALTER TABLE public.trip_overheads ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Trip overheads access"
  ON public.trip_overheads FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- ============================================
-- POST-TRIP ANALYSIS
-- ============================================

CREATE TABLE public.post_trip_analysis (
  trip_id uuid PRIMARY KEY REFERENCES public.trips(id) ON DELETE CASCADE,

  total_expected numeric NOT NULL DEFAULT 0,
  total_actual numeric NOT NULL DEFAULT 0,
  profit_loss numeric NOT NULL DEFAULT 0,
  profit_loss_percentage numeric NOT NULL DEFAULT 0,
  variance_explanation text,
  is_finalized boolean NOT NULL DEFAULT false,

  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE public.post_trip_analysis ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Post-trip analysis access"
  ON public.post_trip_analysis FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM public.trips t
      WHERE t.id = trip_id AND t.created_by = auth.uid()
    )
  );

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

-- Function to validate room allocation JSONB structure
CREATE OR REPLACE FUNCTION validate_room_allocation(allocation jsonb)
RETURNS boolean AS $$
BEGIN
  RETURN (
    allocation ? 'boysRooms' AND
    allocation ? 'girlsRooms' AND
    allocation ? 'maleFacultyRooms' AND
    allocation ? 'femaleFacultyRooms' AND
    allocation ? 'maleVXplorerRooms' AND
    allocation ? 'femaleVXplorerRooms' AND
    allocation ? 'totalRooms'
  );
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Function to validate room types JSONB structure
CREATE OR REPLACE FUNCTION validate_room_types(room_types jsonb)
RETURNS boolean AS $$
DECLARE
  room_type jsonb;
BEGIN
  IF jsonb_typeof(room_types) != 'array' THEN
    RETURN false;
  END IF;
  
  FOR room_type IN SELECT * FROM jsonb_array_elements(room_types)
  LOOP
    IF NOT (
      room_type ? 'roomType' AND
      room_type ? 'capacityPerRoom' AND
      room_type ? 'costPerRoom'
    ) THEN
      RETURN false;
    END IF;
  END LOOP;
  
  RETURN true;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Add constraints using validation functions
ALTER TABLE public.trip_accommodations
  ADD CONSTRAINT valid_room_allocation 
  CHECK (validate_room_allocation(room_allocation));

ALTER TABLE public.trip_accommodations
  ADD CONSTRAINT valid_room_types 
  CHECK (validate_room_types(room_types));

-- ============================================
-- INDEXES FOR PERFORMANCE
-- ============================================

-- Additional indexes for common queries
CREATE INDEX idx_trips_dates ON public.trips(start_date, end_date);
CREATE INDEX idx_trips_country_city ON public.trips(country, city);

-- ============================================
-- SAMPLE DATA (OPTIONAL - FOR TESTING)
-- ============================================

-- Insert sample currencies
INSERT INTO public.currencies (code, name, symbol, rate_to_inr, effective_date) VALUES
  ('INR', 'Indian Rupee', 'â‚¹', 1.00, CURRENT_DATE),
  ('USD', 'US Dollar', '$', 83.50, CURRENT_DATE),
  ('EUR', 'Euro', 'â‚¬', 91.20, CURRENT_DATE),
  ('SGD', 'Singapore Dollar', 'S$', 62.30, CURRENT_DATE),
  ('AED', 'UAE Dirham', 'Ø¯.Ø¥', 22.75, CURRENT_DATE),
  ('GBP', 'British Pound', 'Â£', 105.80, CURRENT_DATE)
ON CONFLICT (code) DO NOTHING;

-- Insert sample countries
INSERT INTO public.countries (name, code, default_currency) VALUES
  ('India', 'IN', 'INR'),
  ('United States', 'US', 'USD'),
  ('United Kingdom', 'GB', 'GBP'),
  ('Singapore', 'SG', 'SGD'),
  ('United Arab Emirates', 'AE', 'AED'),
  ('France', 'FR', 'EUR'),
  ('Germany', 'DE', 'EUR'),
  ('Italy', 'IT', 'EUR'),
  ('Spain', 'ES', 'EUR'),
  ('Thailand', 'TH', 'THB')
ON CONFLICT (name) DO NOTHING;

-- ============================================
-- GRANTS (IF NEEDED FOR SERVICE ROLE)
-- ============================================

-- Grant necessary permissions to authenticated users
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO authenticated;

-- ============================================
-- COMPLETION MESSAGE
-- ============================================

DO $$
BEGIN
  RAISE NOTICE 'âœ… Database schema created successfully!';
  RAISE NOTICE 'ðŸ“‹ Tables created: users, trips, trip_participants, trip_flights, trip_buses, trip_trains';
  RAISE NOTICE 'ðŸ“‹ Tables created: trip_accommodations (with auto-allocation), trip_meals, trip_activities, trip_overheads';
  RAISE NOTICE 'ðŸ“‹ Tables created: post_trip_analysis, countries, cities, currencies, institutions';
  RAISE NOTICE 'ðŸ”’ Row Level Security enabled on all tables';
  RAISE NOTICE 'âœ¨ Room auto-allocation system ready!';
END $$;